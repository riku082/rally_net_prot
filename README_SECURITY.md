# Firebase セキュリティ設定

## 概要

このドキュメントでは、Rally NetアプリケーションのFirebaseセキュリティ設定について説明します。

## セキュリティルール

### Firestore セキュリティルール (`firestore.rules`)

#### 主要なセキュリティ機能

1. **認証チェック**
   - すべてのデータアクセスには認証が必要
   - 未認証ユーザーはデータにアクセス不可

2. **所有者ベースのアクセス制御**
   - ユーザーは自分のデータのみ読み書き可能
   - 他のユーザーのデータにはアクセス不可

3. **フレンド関係の制御**
   - フレンド関係にあるユーザー間でのデータ共有
   - フレンドリクエストの適切な制御

4. **データ保護**
   - プロフィール削除は禁止
   - フィードバックは作成のみ許可（読み取りは管理者のみ）

#### コレクション別のアクセス制御

| コレクション | 読み取り | 書き込み | 削除 | 備考 |
|-------------|---------|---------|------|------|
| userProfiles | 認証済み全員 | 所有者のみ | 禁止 | プロフィール検索用 |
| players | 所有者のみ | 所有者のみ | 所有者のみ | 選手データ |
| users/{userId}/* | 所有者のみ | 所有者のみ | 所有者のみ | ユーザーサブコレクション |
| friendships | 関係者 | 関係者 | 関係者 | フレンド関係 |
| matchRequests | 関係者 | 関係者 | 関係者 | 試合リクエスト |
| mbtiResults | 所有者のみ | 所有者のみ | 所有者のみ | MBTI診断結果 |
| user_feedback | 管理者のみ | 認証済み全員 | 管理者のみ | フィードバック |

### Storage セキュリティルール (`storage.rules`)

#### ファイルアクセス制御

1. **ファイルサイズ制限**
   - 最大5MBまでアップロード可能

2. **ファイル形式制限**
   - 画像ファイルのみアップロード可能
   - `image/*` 形式のみ許可

3. **パス別アクセス制御**

| パス | 読み取り | 書き込み | 備考 |
|------|---------|---------|------|
| avatars/{userId}/* | 認証済み全員 | 所有者のみ | アバター画像 |
| matches/{userId}/{matchId}/* | 認証済み全員 | 所有者のみ | 試合関連画像 |
| practices/{userId}/{practiceId}/* | 認証済み全員 | 所有者のみ | 練習記録画像 |

## デプロイ方法

### 1. Firebase CLIのインストール

```bash
npm install -g firebase-tools
```

### 2. Firebaseプロジェクトにログイン

```bash
firebase login
```

### 3. プロジェクトの初期化

```bash
firebase init
```

### 4. セキュリティルールのデプロイ

```bash
# Firestoreルールのデプロイ
firebase deploy --only firestore:rules

# Storageルールのデプロイ
firebase deploy --only storage

# インデックスのデプロイ
firebase deploy --only firestore:indexes
```

### 5. 全体的なデプロイ

```bash
firebase deploy
```

## セキュリティテスト

### ローカルエミュレーターでのテスト

```bash
# エミュレーターの起動
firebase emulators:start

# セキュリティルールのテスト
firebase emulators:exec --only firestore,storage "npm test"
```

## ベストプラクティス

### 1. 最小権限の原則
- 必要最小限の権限のみを付与
- デフォルトではアクセスを拒否

### 2. データ検証
- クライアントサイドでの検証に加え、サーバーサイドでも検証
- 不正なデータの挿入を防止

### 3. 監査ログ
- 重要な操作のログを記録
- 異常なアクセスパターンの監視

### 4. 定期的な見直し
- セキュリティルールの定期的な見直し
- 新しい脅威への対応

## トラブルシューティング

### よくある問題

1. **権限エラー**
   - ユーザーが認証されているか確認
   - データの所有者が正しいか確認

2. **インデックスエラー**
   - 必要なインデックスが作成されているか確認
   - 複合クエリのインデックス設定

3. **ファイルアップロードエラー**
   - ファイルサイズが制限内か確認
   - ファイル形式が許可されているか確認

## 更新履歴

- v1.0.0: 初期セキュリティルール設定
  - Firestoreセキュリティルール
  - Storageセキュリティルール
  - インデックス設定 